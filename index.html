<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório Financeiro Familiar</title>
    
    <!-- Tratamento de Erros Global -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const root = document.getElementById('root');
            if (root && !root.innerHTML.includes("Erro de Carregamento")) {
                root.innerHTML = `
                    <div style="color: #7f1d1d; background-color: #fef2f2; padding: 20px; font-family: sans-serif; border: 1px solid #f87171; border-radius: 8px; max-width: 600px; margin: 40px auto;">
                        <h3 style="margin-top: 0;">Erro de Carregamento</h3>
                        <p><strong>O que aconteceu:</strong> O navegador não conseguiu carregar as ferramentas necessárias.</p>
                        <p style="font-size: 0.9em; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 4px;">Erro técnico: ${message}</p>
                        <button onclick="window.location.reload()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px;">Tentar Novamente</button>
                    </div>
                `;
            }
        };
    </script>

    <!-- 1. Chart.js (Substituindo Recharts por ser mais robusto em CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.10/babel.min.js"></script>
    
    <!-- 4. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 5. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0f172a',
                        secondary: '#334155',
                        accent: '#2563eb',
                        danger: '#ef4444',
                        success: '#10b981'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        .card { @apply bg-white rounded-xl shadow-sm border border-slate-200 p-6; }
        select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; height: 100vh; flex-direction: column; align-items: center; justify-content: center; color: #64748b; font-family: sans-serif;">
            <div style="margin-bottom: 20px;">
                <svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #2563eb;"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
            </div>
            <p>Carregando sistema financeiro...</p>
        </div>
    </div>

    <script type="text/babel">
        // Verificação de dependências
        if (!window.React || !window.ReactDOM || !window.Chart) {
            throw new Error("Bibliotecas essenciais não carregaram. Verifique sua conexão.");
        }
        
        const { useState, useEffect, useMemo, useRef } = React;

        // --- COMPONENTE DE GRÁFICO (Chart.js Wrapper) ---
        const ChartComponent = ({ type, data, options }) => {
            const canvasRef = useRef(null);
            const chartInstanceRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;

                // Destrói gráfico anterior se existir para evitar sobreposição/erros
                if (chartInstanceRef.current) {
                    chartInstanceRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                chartInstanceRef.current = new Chart(ctx, {
                    type: type,
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        ...options
                    }
                });

                // Limpeza ao desmontar
                return () => {
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy();
                    }
                };
            }, [data, type, options]); // Recria se os dados mudarem

            return <div style={{ position: 'relative', height: '100%', width: '100%' }}><canvas ref={canvasRef} /></div>;
        };

        // --- COMPONENTES UI ---

        const StatCard = ({ title, value, subtext, icon, trend }) => (
            <div className="card hover:shadow-md transition-shadow">
                <div className="flex justify-between items-start mb-4">
                    <div>
                        <p className="text-slate-500 text-xs font-bold uppercase tracking-wider">{title}</p>
                        <h3 className="text-2xl font-bold text-slate-800 mt-1">{value}</h3>
                    </div>
                    <div className="p-2 bg-slate-100 rounded-lg text-slate-600">
                        {icon}
                    </div>
                </div>
                {subtext && (
                    <div className="flex items-center text-sm">
                        <span className={`font-medium ${trend === 'up' ? 'text-danger' : 'text-slate-500'}`}>
                            {subtext}
                        </span>
                    </div>
                )}
            </div>
        );

        const LoadingState = () => (
            <div className="flex flex-col items-center justify-center min-h-screen text-slate-500">
                <i data-lucide="loader-2" className="w-10 h-10 animate-spin mb-4 text-accent"></i>
                <p>Processando dados...</p>
            </div>
        );

        // --- APP PRINCIPAL ---

        const App = () => {
            const FIXED_API_URL = "https://script.google.com/macros/s/AKfycbwljwdhw-IaiFjUISQEanjiSyzoTdmkA4S3dFvx0e4FbBLUTFXvUrwiMt-As1Poo0I_zw/exec";

            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [selectedMonthKey, setSelectedMonthKey] = useState(""); 
            const [apiUrl] = useState(FIXED_API_URL);
            
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [loading, data]);

            // Busca os dados
            const fetchData = async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${apiUrl}?t=${new Date().getTime()}`);
                    const contentType = response.headers.get("content-type");
                    
                    if (contentType && contentType.indexOf("application/json") === -1) {
                        throw new Error("Erro de Permissão: Verifique se o script está como 'Qualquer pessoa'.");
                    }

                    const json = await response.json();
                    
                    if (json.status === 'sucesso') {
                        setData(json.data);
                        setError(null);
                        
                        // Define o mês inicial
                        if (json.data && json.data.length > 0) {
                            const sorted = [...json.data].sort((a, b) => (a.ano - b.ano) || (a.mesId - b.mesId));
                            const last = sorted[sorted.length - 1];
                            setSelectedMonthKey(`${last.ano}-${last.mesId}`);
                        }
                    } else if (json.error) {
                        throw new Error(json.error);
                    } else {
                        throw new Error("Erro na estrutura dos dados");
                    }
                } catch (err) {
                    console.error(err);
                    let msg = err.message || "Falha ao carregar dados.";
                    if (msg.includes("JSON")) msg = "Erro de Acesso: O Google bloqueou a leitura.";
                    setError(msg);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchData();
            }, []);

            // Processamento
            const analysis = useMemo(() => {
                if (!data || data.length === 0) return null;

                const monthsMap = new Map();
                data.forEach(item => {
                    const key = `${item.ano}-${item.mesId}`;
                    if (!monthsMap.has(key)) {
                        monthsMap.set(key, { key, label: `${item.mesNome}/${item.ano}`, ano: item.ano, mesId: item.mesId });
                    }
                });
                const availableMonths = Array.from(monthsMap.values()).sort((a, b) => (b.ano - a.ano) || (b.mesId - a.mesId));

                const currentKey = selectedMonthKey || (availableMonths[0] ? availableMonths[0].key : "");
                const [selAno, selMesId] = currentKey.split('-').map(Number);
                
                const currentMonthData = data.filter(d => d.ano === selAno && d.mesId === selMesId);
                
                let prevMesId = selMesId - 1;
                let prevAno = selAno;
                if (prevMesId === 0) { prevMesId = 12; prevAno = selAno - 1; }
                const prevMonthData = data.filter(d => d.ano === prevAno && d.mesId === prevMesId);

                const totalCurrent = currentMonthData.reduce((acc, cur) => acc + cur.valor, 0);
                const totalPrev = prevMonthData.reduce((acc, cur) => acc + cur.valor, 0);

                // Dados para o Gráfico de Categorias (Chart.js format)
                const catMap = {};
                currentMonthData.forEach(d => {
                    catMap[d.categoriaMacro] = (catMap[d.categoriaMacro] || 0) + d.valor;
                });
                // Ordena e prepara labels/values
                const sortedCats = Object.entries(catMap).sort((a, b) => b[1] - a[1]);
                const chartJsCategoryData = {
                    labels: sortedCats.map(c => c[0]),
                    datasets: [{
                        data: sortedCats.map(c => c[1]),
                        backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1'],
                        borderWidth: 0
                    }]
                };

                // Dados para Evolução (Chart.js format)
                const evolMap = {};
                data.forEach(d => {
                    const k = `${d.mesNome}/${d.ano}`;
                    const sortKey = d.ano * 100 + d.mesId; 
                    if (!evolMap[sortKey]) evolMap[sortKey] = { name: k, total: 0 };
                    evolMap[sortKey].total += d.valor;
                });
                const sortedEvol = Object.values(evolMap).sort((a, b) => a.sortKey - b.sortKey); // Note: object keys iteration isn't strictly ordered, relying on sortKey implicitly via earlier sort logic if array
                // Melhor garantir a ordem com array:
                const evolArray = Object.keys(evolMap).sort().map(k => evolMap[k]);
                
                const chartJsEvolutionData = {
                    labels: evolArray.map(i => i.name),
                    datasets: [{
                        label: 'Total Mensal',
                        data: evolArray.map(i => i.total),
                        backgroundColor: '#2563eb',
                        borderRadius: 4
                    }]
                };

                // Projeção
                const allMonthsTotal = evolArray.map(m => m.total);
                const avg = allMonthsTotal.length ? allMonthsTotal.reduce((a,b)=>a+b,0) / allMonthsTotal.length : 0;
                const toBRL = (val) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                return {
                    availableMonths,
                    currentMonthLabel: availableMonths.find(m => m.key === currentKey)?.label || '-',
                    totalCurrent: toBRL(totalCurrent),
                    totalPrev: toBRL(totalPrev),
                    projection: toBRL(avg),
                    topCategory: sortedCats[0] ? sortedCats[0][0] : '-',
                    chartJsCategoryData,
                    chartJsEvolutionData,
                    tableData: currentMonthData.sort((a,b) => {
                        const da = new Date(a.dataPagamento.split('/').reverse().join('-'));
                        const db = new Date(b.dataPagamento.split('/').reverse().join('-'));
                        return da - db;
                    })
                };
            }, [data, selectedMonthKey]);

            // --- RENDER ---

            if (loading) return <LoadingState />;

            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                        <div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full text-center">
                            <i data-lucide="alert-triangle" className="w-12 h-12 text-danger mx-auto mb-4"></i>
                            <h3 className="text-xl font-bold text-slate-800">Erro ao carregar</h3>
                            <p className="text-slate-500 mt-2 mb-6">{error}</p>
                            <button onClick={() => window.location.reload()} className="w-full bg-accent text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">
                                Tentar Novamente
                            </button>
                        </div>
                    </div>
                );
            }

            if (!analysis) return <div className="p-10 text-center">Sem dados.</div>;

            return (
                <div className="min-h-screen pb-12 font-sans text-slate-900">
                    {/* Header */}
                    <header className="bg-blue-600 text-white shadow-lg sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 md:px-8 py-4">
                            <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                <div>
                                    <h1 className="text-xl md:text-2xl font-bold flex items-center gap-2">
                                        <i data-lucide="layout-dashboard" className="w-6 h-6"></i>
                                        Relatório Financeiro
                                    </h1>
                                    <p className="text-blue-100 text-sm opacity-90">Visão geral dos gastos familiares</p>
                                </div>
                                
                                <div className="w-full md:w-auto">
                                    <div className="relative">
                                        <select 
                                            value={selectedMonthKey}
                                            onChange={(e) => setSelectedMonthKey(e.target.value)}
                                            className="w-full md:w-48 appearance-none bg-blue-700 hover:bg-blue-800 text-white border border-blue-500 rounded-lg py-2 pl-4 pr-10 focus:outline-none focus:ring-2 focus:ring-white/50 cursor-pointer font-medium transition-colors"
                                        >
                                            {analysis.availableMonths.map(m => (
                                                <option key={m.key} value={m.key}>{m.label}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 md:px-8 py-8 space-y-8">
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <StatCard title={`Total em ${analysis.currentMonthLabel.split('/')[0]}`} value={analysis.totalCurrent} icon={<i data-lucide="wallet" className="w-6 h-6"></i>} subtext="Mês selecionado" />
                            <StatCard title="Mês Anterior" value={analysis.totalPrev} icon={<i data-lucide="calendar-clock" className="w-6 h-6"></i>} subtext="Comparativo" />
                            <StatCard title="Média Mensal" value={analysis.projection} icon={<i data-lucide="trending-up" className="w-6 h-6"></i>} subtext="Baseado no histórico" />
                            <StatCard title="Maior Categoria" value={analysis.topCategory} icon={<i data-lucide="pie-chart" className="w-6 h-6"></i>} subtext="Onde mais se gastou" trend="up" />
                        </div>

                        {/* Gráficos (Usando Chart.js agora) */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            {/* Evolução */}
                            <div className="card lg:col-span-2 min-h-[400px] flex flex-col">
                                <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                                    <i data-lucide="bar-chart-2" className="w-5 h-5 text-accent"></i> Evolução dos Gastos
                                </h3>
                                <div className="flex-1 w-full min-h-[300px]">
                                    <ChartComponent 
                                        type="bar" 
                                        data={analysis.chartJsEvolutionData}
                                        options={{
                                            plugins: { legend: { display: false } },
                                            scales: {
                                                y: { beginAtZero: true, ticks: { callback: (val) => 'R$ ' + val } },
                                                x: { grid: { display: false } }
                                            }
                                        }}
                                    />
                                </div>
                            </div>

                            {/* Categorias Pizza */}
                            <div className="card min-h-[400px] flex flex-col">
                                <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                                    <i data-lucide="donut" className="w-5 h-5 text-accent"></i> 
                                    Categorias de {analysis.currentMonthLabel.split('/')[0]}
                                </h3>
                                <div className="flex-1 w-full min-h-[300px]">
                                    {analysis.chartJsCategoryData.labels.length > 0 ? (
                                        <ChartComponent 
                                            type="doughnut" 
                                            data={analysis.chartJsCategoryData}
                                            options={{
                                                plugins: { legend: { position: 'bottom' } },
                                                cutout: '60%'
                                            }}
                                        />
                                    ) : (
                                        <div className="flex items-center justify-center h-full text-slate-400 bg-slate-50 rounded-lg">
                                            Sem dados neste mês
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Tabela */}
                        <div className="card overflow-hidden">
                            <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                                <i data-lucide="list" className="w-5 h-5 text-accent"></i> 
                                Detalhamento - {analysis.currentMonthLabel}
                            </h3>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm text-slate-600 border-collapse">
                                    <thead className="bg-slate-50 text-slate-700 uppercase font-bold text-xs">
                                        <tr>
                                            <th className="p-4 rounded-tl-lg border-b border-slate-200">Data</th>
                                            <th className="p-4 border-b border-slate-200">Categoria</th>
                                            <th className="p-4 border-b border-slate-200">Descrição</th>
                                            <th className="p-4 border-b border-slate-200">Valor</th>
                                            <th className="p-4 border-b border-slate-200">Obs</th>
                                            <th className="p-4 rounded-tr-lg text-center border-b border-slate-200">Comprovante</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {analysis.tableData.length > 0 ? (
                                            analysis.tableData.map((row, idx) => (
                                                <tr key={idx} className="hover:bg-blue-50/50 transition-colors">
                                                    <td className="p-4 whitespace-nowrap">{row.dataPagamento}</td>
                                                    <td className="p-4">
                                                        <span className="bg-slate-100 text-slate-700 px-2 py-1 rounded text-xs font-bold border border-slate-200">
                                                            {row.categoriaMacro}
                                                        </span>
                                                    </td>
                                                    <td className="p-4 font-medium text-slate-900">{row.categoriaMicro}</td>
                                                    <td className="p-4 font-bold text-slate-700">
                                                        {row.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                                                    </td>
                                                    <td className="p-4 max-w-xs truncate text-slate-500" title={row.observacao}>{row.observacao || '-'}</td>
                                                    <td className="p-4 text-center">
                                                        {row.linkComprovante ? (
                                                            <a href={row.linkComprovante} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 inline-flex items-center gap-1 font-medium bg-blue-50 px-3 py-1 rounded-full text-xs hover:bg-blue-100 transition-colors">
                                                                <i data-lucide="external-link" className="w-3 h-3"></i> Ver
                                                            </a>
                                                        ) : (
                                                            <span className="text-slate-300">-</span>
                                                        )}
                                                    </td>
                                                </tr>
                                            ))
                                        ) : (
                                            <tr>
                                                <td colspan="6" className="p-8 text-center text-slate-400 italic">
                                                    Nenhum gasto registrado neste mês.
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
