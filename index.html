<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório Financeiro Familiar</title>
    
    <!-- Tratamento de Erros Global -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const root = document.getElementById('root');
            if (root && !root.innerHTML.includes("Erro de Carregamento")) {
                root.innerHTML = `
                    <div style="color: #7f1d1d; background-color: #fef2f2; padding: 20px; font-family: sans-serif; border: 1px solid #f87171; border-radius: 8px; max-width: 600px; margin: 40px auto;">
                        <h3 style="margin-top: 0;">Erro de Carregamento</h3>
                        <p><strong>O que aconteceu:</strong> O sistema encontrou um problema técnico.</p>
                        <p style="font-size: 0.9em; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 4px;">Erro técnico: ${message}</p>
                        <button onclick="window.location.reload()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px;">Tentar Novamente</button>
                    </div>
                `;
            }
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.10/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0f172a',
                        secondary: '#334155',
                        accent: '#2563eb',
                        danger: '#ef4444',
                        success: '#10b981',
                        warning: '#f59e0b'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        .card { @apply bg-white rounded-xl shadow-sm border border-slate-200 p-6; }
        select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        /* Estilo para o select claro (filtro da tabela) */
        .select-light { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; height: 100vh; flex-direction: column; align-items: center; justify-content: center; color: #64748b; font-family: sans-serif;">
            <div style="margin-bottom: 20px;">
                <svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #2563eb;"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
            </div>
            <p>Carregando sistema financeiro...</p>
        </div>
    </div>

    <script type="text/babel">
        if (!window.React || !window.ReactDOM || !window.Chart) { throw new Error("Bibliotecas essenciais não carregaram."); }
        
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CHART WRAPPER ---
        const ChartComponent = ({ type, data, options }) => {
            const canvasRef = useRef(null);
            const chartInstanceRef = useRef(null);
            useEffect(() => {
                if (!canvasRef.current) return;
                if (chartInstanceRef.current) chartInstanceRef.current.destroy();
                const ctx = canvasRef.current.getContext('2d');
                chartInstanceRef.current = new Chart(ctx, { type, data, options: { responsive: true, maintainAspectRatio: false, ...options } });
                return () => { if (chartInstanceRef.current) chartInstanceRef.current.destroy(); };
            }, [data, type, options]);
            return <div style={{ position: 'relative', height: '100%', width: '100%' }}><canvas ref={canvasRef} /></div>;
        };

        // --- UI COMPONENTS ---
        const StatCard = ({ title, value, subtext, icon, type }) => (
            <div className="card hover:shadow-md transition-shadow">
                <div className="flex justify-between items-start mb-4">
                    <div>
                        <p className="text-slate-500 text-xs font-bold uppercase tracking-wider">{title}</p>
                        <h3 className={`text-2xl font-bold mt-1 ${type === 'danger' ? 'text-red-600' : type === 'success' ? 'text-green-600' : type === 'warning' ? 'text-yellow-600' : 'text-slate-800'}`}>{value}</h3>
                    </div>
                    <div className="p-2 bg-slate-100 rounded-lg text-slate-600">{icon}</div>
                </div>
                {subtext && <div className="flex items-center text-sm text-slate-500 font-medium">{subtext}</div>}
            </div>
        );

        const StatusBadge = ({ status }) => {
            // Normalização robusta também na tabela
            const normalized = (status || "").toString().toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const isPago = normalized === "pago";
            return (
                <span className={`px-2 py-1 rounded text-xs font-bold border inline-flex items-center gap-1 ${isPago ? 'bg-green-100 text-green-700 border-green-200' : 'bg-yellow-100 text-yellow-700 border-yellow-200'}`}>
                    {isPago ? <i data-lucide="check-circle-2" className="w-3 h-3"></i> : <i data-lucide="clock" className="w-3 h-3"></i>}
                    {status || "Pendente"}
                </span>
            );
        };

        const LoadingState = () => (
            <div className="flex flex-col items-center justify-center min-h-screen text-slate-500">
                <i data-lucide="loader-2" className="w-10 h-10 animate-spin mb-4 text-accent"></i>
                <p>Processando dados...</p>
            </div>
        );

        // --- MAIN APP ---
        const App = () => {
            // URL ATUALIZADA
            const FIXED_API_URL = "https://script.google.com/macros/s/AKfycby3j0OHxghEhaN7OqmKhZ23T95vo_x0lGsRGqOEAEsSbbAQITABQBg0wpfff_Q13TABRw/exec";

            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [selectedMonthKey, setSelectedMonthKey] = useState(""); 
            const [selectedTypeFilter, setSelectedTypeFilter] = useState("all"); 
            const [apiUrl] = useState(FIXED_API_URL);
            
            useEffect(() => { 
                if (window.lucide) window.lucide.createIcons(); 
            }, [loading, data, selectedMonthKey, selectedTypeFilter]);

            const fetchData = async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${apiUrl}?t=${new Date().getTime()}`);
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") === -1) { throw new Error("Erro de Permissão: Verifique se o script está como 'Qualquer pessoa'."); }
                    const json = await response.json();
                    if (json.status === 'sucesso') {
                        setData(json.data);
                        setError(null);
                        if (json.data && json.data.length > 0) {
                            const sorted = [...json.data].sort((a, b) => (a.ano - b.ano) || (a.mesId - b.mesId));
                            const last = sorted[sorted.length - 1];
                            setSelectedMonthKey(`${last.ano}-${last.mesId}`);
                        }
                    } else if (json.error) { throw new Error(json.error); }
                    else { throw new Error("Estrutura de dados inválida"); }
                } catch (err) {
                    let msg = err.message || "Falha ao carregar.";
                    if (msg.includes("JSON")) msg = "Erro de Acesso: Verifique permissões no Apps Script.";
                    setError(msg);
                } finally { setLoading(false); }
            };

            useEffect(() => { fetchData(); }, []);

            const analysis = useMemo(() => {
                if (!data || data.length === 0) return null;

                // 1. Organizar Meses
                const monthsMap = new Map();
                data.forEach(item => {
                    const key = `${item.ano}-${item.mesId}`;
                    if (!monthsMap.has(key)) monthsMap.set(key, { key, label: `${item.mesNome}/${item.ano}`, ano: item.ano, mesId: item.mesId });
                });
                const availableMonths = Array.from(monthsMap.values()).sort((a, b) => (b.ano - a.ano) || (b.mesId - a.mesId));

                // 2. Filtro Atual
                const currentKey = selectedMonthKey || (availableMonths[0] ? availableMonths[0].key : "");
                const [selAno, selMesId] = currentKey.split('-').map(Number);
                
                // Dados do Mês
                const currentMonthData = data.filter(d => d.ano === selAno && d.mesId === selMesId);

                // Helper de Normalização
                const normalize = (text) => (text || "").toString().toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

                // 3. Totais (Separando Entrada vs Saída)
                const isSaida = (d) => normalize(d.tipo).includes('saida');
                const isEntrada = (d) => normalize(d.tipo).includes('entrada');
                const isPago = (d) => normalize(d.status) === 'pago';

                // Cálculo para o "Saldo em Caixa" (Entradas - Saídas PAGAS)
                const totalEntradasCurrent = currentMonthData.filter(isEntrada).reduce((acc, cur) => acc + cur.valor, 0);
                const totalSaidasPagas = currentMonthData.filter(d => isSaida(d) && isPago(d)).reduce((acc, cur) => acc + cur.valor, 0);
                const saldoCaixa = totalEntradasCurrent - totalSaidasPagas;

                // Total de Saídas (Geral, incluindo pendentes, para os outros cards)
                const totalSaidasGeral = currentMonthData.filter(isSaida).reduce((acc, cur) => acc + cur.valor, 0);
                
                // Balanço Geral (Entradas - Saídas Totais)
                const balance = totalEntradasCurrent - totalSaidasGeral;

                // 4. Gráfico de Categorias (Saídas do Mês)
                const catMap = {};
                currentMonthData.filter(isSaida).forEach(d => {
                    catMap[d.categoriaMacro] = (catMap[d.categoriaMacro] || 0) + d.valor;
                });
                const sortedCats = Object.entries(catMap).sort((a, b) => b[1] - a[1]);
                
                const chartJsCategoryData = {
                    labels: sortedCats.map(c => c[0]),
                    datasets: [{
                        data: sortedCats.map(c => c[1]),
                        backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6', '#ec4899'],
                        borderWidth: 0
                    }]
                };

                // 5. Gráfico de Evolução
                const evolMap = {};
                data.forEach(d => {
                    const sortKey = d.ano * 100 + d.mesId; 
                    if (!evolMap[sortKey]) evolMap[sortKey] = { name: `${d.mesNome}/${d.ano}`, saida: 0, entradaFamilia: 0, entradaMae: 0 };
                    
                    if (isSaida(d)) {
                        evolMap[sortKey].saida += d.valor;
                    } else if (isEntrada(d)) {
                        const cat = (d.categoriaMacro || "").toLowerCase();
                        if (cat.includes("família") || cat.includes("familia")) {
                            evolMap[sortKey].entradaFamilia += d.valor;
                        } else {
                            evolMap[sortKey].entradaMae += d.valor;
                        }
                    }
                });
                const evolArray = Object.keys(evolMap).sort().map(k => evolMap[k]);

                const chartJsEvolutionData = {
                    labels: evolArray.map(i => i.name),
                    datasets: [
                        {
                            label: 'Entrada (Lucinda)', 
                            data: evolArray.map(i => i.entradaMae),
                            backgroundColor: '#10b981', 
                            stack: 'stack0',
                        },
                        {
                            label: 'Entrada (Família)',
                            data: evolArray.map(i => i.entradaFamilia),
                            backgroundColor: '#34d399', 
                            stack: 'stack0',
                        },
                        {
                            label: 'Saídas Totais',
                            data: evolArray.map(i => i.saida),
                            backgroundColor: '#ef4444', 
                            stack: 'stack1',
                        }
                    ]
                };

                const toBRL = (val) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                // 6. Dados da Tabela
                let filteredTableData = currentMonthData;
                if (selectedTypeFilter !== 'all') {
                    filteredTableData = currentMonthData.filter(d => {
                        if (selectedTypeFilter === 'entrada') return isEntrada(d);
                        if (selectedTypeFilter === 'saida') return isSaida(d);
                        return true;
                    });
                }

                return {
                    availableMonths,
                    currentMonthLabel: availableMonths.find(m => m.key === currentKey)?.label || '-',
                    totalSaidasCurrent: toBRL(totalSaidasGeral),
                    saldoCaixa: toBRL(saldoCaixa),
                    totalEntradasCurrent: toBRL(totalEntradasCurrent),
                    balance: toBRL(balance),
                    isPositive: balance >= 0,
                    chartJsCategoryData, 
                    chartJsEvolutionData,
                    tableData: filteredTableData.sort((a,b) => {
                        const dateA = a.dataVencimento || a.dataPagamento;
                        const dateB = b.dataVencimento || b.dataPagamento;
                        if (!dateA) return 1; if (!dateB) return -1;
                        return new Date(dateA.split('/').reverse().join('-')) - new Date(dateB.split('/').reverse().join('-'));
                    })
                };
            }, [data, selectedMonthKey, selectedTypeFilter]);

            if (loading) return <LoadingState />;

            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                        <div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full text-center">
                            <i data-lucide="alert-triangle" className="w-12 h-12 text-danger mx-auto mb-4"></i>
                            <h3 className="text-xl font-bold text-slate-800">Erro ao carregar</h3>
                            <p className="text-slate-500 mt-2 mb-6">{error}</p>
                            <button onClick={() => window.location.reload()} className="w-full bg-accent text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">Tentar Novamente</button>
                        </div>
                    </div>
                );
            }

            if (!analysis) return <div className="p-10 text-center">Sem dados.</div>;

            return (
                <div className="min-h-screen pb-12 font-sans text-slate-900 bg-slate-50">
                    {/* Header */}
                    <header className="bg-blue-600 text-white shadow-lg sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 md:px-8 py-4">
                            <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                <div>
                                    <h1 className="text-xl md:text-2xl font-bold flex items-center gap-2">
                                        <i data-lucide="layout-dashboard" className="w-6 h-6"></i>
                                        Relatório Financeiro
                                    </h1>
                                    <p className="text-blue-100 text-sm opacity-90">Visão geral da conta de Lucinda</p>
                                </div>
                                <div className="w-full md:w-auto relative">
                                    <select 
                                        value={selectedMonthKey}
                                        onChange={(e) => setSelectedMonthKey(e.target.value)}
                                        className="w-full md:w-48 appearance-none bg-blue-700 hover:bg-blue-800 text-white border border-blue-500 rounded-lg py-2 pl-4 pr-10 focus:outline-none cursor-pointer font-medium transition-colors"
                                    >
                                        {analysis.availableMonths.map(m => ( <option key={m.key} value={m.key}>{m.label}</option> ))}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 md:px-8 py-8 space-y-8">
                        
                        {/* KPI Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <StatCard 
                                title="Saídas (Gastos)" 
                                value={analysis.totalSaidasCurrent} 
                                icon={<i data-lucide="trending-down" className="w-6 h-6 text-red-500"></i>}
                                subtext={`Em ${analysis.currentMonthLabel.split('/')[0]}`}
                                type="danger"
                            />
                            <StatCard 
                                title="Entradas (Total)" 
                                value={analysis.totalEntradasCurrent} 
                                icon={<i data-lucide="trending-up" className="w-6 h-6 text-green-500"></i>}
                                subtext="Soma de Lucinda + Família"
                                type="success"
                            />
                            <StatCard 
                                title="Saldo Geral" 
                                value={analysis.balance} 
                                icon={<i data-lucide="scale" className="w-6 h-6"></i>}
                                subtext="Entradas - Todas Saídas"
                                type={analysis.isPositive ? 'success' : 'danger'}
                            />
                            
                            <StatCard 
                                title="Saldo em Caixa" 
                                value={analysis.saldoCaixa} 
                                icon={<i data-lucide="wallet" className="w-6 h-6"></i>}
                                subtext="Entradas - Saídas Pagas"
                                type="warning"
                            />
                        </div>

                        {/* Gráficos */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div className="card h-[450px] flex flex-col lg:col-span-2">
                                <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                                    <i data-lucide="bar-chart-2" className="w-5 h-5 text-accent"></i> 
                                    Entradas vs Saídas (Evolução)
                                </h3>
                                <div className="flex-1 w-full">
                                    <ChartComponent 
                                        type="bar" 
                                        data={analysis.chartJsEvolutionData}
                                        options={{
                                            plugins: { 
                                                legend: { position: 'top' },
                                                tooltip: { 
                                                    mode: 'index', 
                                                    intersect: false,
                                                    callbacks: { label: (c) => ` ${c.dataset.label}: R$ ${c.raw.toLocaleString('pt-BR')}` }
                                                }
                                            },
                                            scales: {
                                                y: { 
                                                    beginAtZero: true, 
                                                    stacked: true,
                                                    ticks: { callback: (val) => 'R$ ' + val } 
                                                },
                                                x: { 
                                                    stacked: true,
                                                    grid: { display: false } 
                                                }
                                            },
                                            interaction: { mode: 'nearest', axis: 'x', intersect: false }
                                        }}
                                    />
                                </div>
                                <p className="text-xs text-slate-400 mt-2 text-center">
                                    * A barra da esquerda mostra as entradas (divisão Lucinda/Família). A barra da direita (vermelha) mostra o total de saídas.
                                </p>
                            </div>
                            
                            <div className="card h-[450px] flex flex-col">
                                <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                                    <i data-lucide="pie-chart" className="w-5 h-5 text-accent"></i> 
                                    Gastos por Categoria
                                </h3>
                                <div className="flex-1 w-full">
                                    {analysis.chartJsCategoryData.labels.length > 0 ? (
                                        <ChartComponent 
                                            type="doughnut" 
                                            data={analysis.chartJsCategoryData}
                                            options={{
                                                plugins: { 
                                                    legend: { position: 'bottom' },
                                                    tooltip: { 
                                                        callbacks: { label: (c) => ` ${c.label}: R$ ${c.raw.toLocaleString('pt-BR')}` }
                                                    }
                                                },
                                                cutout: '60%'
                                            }}
                                        />
                                    ) : (
                                        <div className="flex items-center justify-center h-full text-slate-400 bg-slate-50 rounded-lg">
                                            Sem saídas neste mês
                                        </div>
                                    )}
                                </div>
                                <p className="text-xs text-slate-400 mt-2 text-center">
                                    * Distribuição dos gastos (fixos vs variáveis) do mês selecionado.
                                </p>
                            </div>
                        </div>

                        {/* Tabela de Detalhes */}
                        <div className="card overflow-hidden">
                            <div className="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                                <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                    <i data-lucide="list" className="w-5 h-5 text-accent"></i> 
                                    Detalhamento - {analysis.currentMonthLabel}
                                </h3>
                                
                                <div className="w-full sm:w-auto relative">
                                    <select 
                                        value={selectedTypeFilter}
                                        onChange={(e) => setSelectedTypeFilter(e.target.value)}
                                        className="select-light w-full sm:w-48 appearance-none bg-white hover:bg-slate-50 text-slate-700 border border-slate-300 rounded-lg py-2 pl-4 pr-10 focus:outline-none focus:ring-2 focus:ring-accent/50 cursor-pointer font-medium transition-colors"
                                    >
                                        <option value="all">Todas as Movimentações</option>
                                        <option value="saida">Apenas Saídas (Gastos)</option>
                                        <option value="entrada">Apenas Entradas</option>
                                    </select>
                                </div>
                            </div>

                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm text-slate-600 border-collapse">
                                    <thead className="bg-slate-50 text-slate-700 uppercase font-bold text-xs">
                                        <tr>
                                            <th className="p-4 border-b">Vencimento</th>
                                            <th className="p-4 border-b">Tipo</th>
                                            <th className="p-4 border-b">Categoria</th>
                                            <th className="p-4 border-b">Descrição</th>
                                            <th className="p-4 border-b text-right">Valor</th>
                                            <th className="p-4 border-b text-center">Status</th>
                                            <th className="p-4 border-b text-center">Comp.</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {analysis.tableData.length > 0 ? (
                                            analysis.tableData.map((row, idx) => {
                                                const isEntrada = row.tipo && row.tipo.toLowerCase().includes('entrada');
                                                return (
                                                    <tr key={idx} className="hover:bg-slate-50 transition-colors">
                                                        <td className="p-4 font-medium text-slate-800">{row.dataVencimento || '-'}</td>
                                                        <td className="p-4">
                                                            <span className={`px-2 py-1 rounded text-xs font-bold border ${isEntrada ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200'}`}>
                                                                {row.tipo}
                                                            </span>
                                                        </td>
                                                        <td className="p-4">{row.categoriaMacro}</td>
                                                        <td className="p-4 text-slate-900">{row.categoriaMicro}</td>
                                                        <td className={`p-4 text-right font-bold ${isEntrada ? 'text-green-600' : 'text-red-600'}`}>
                                                            {row.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                                                        </td>
                                                        <td className="p-4 text-center">
                                                            <StatusBadge status={row.status} />
                                                        </td>
                                                        <td className="p-4 text-center">
                                                            {row.linkComprovante ? (
                                                                <a href={row.linkComprovante} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800">
                                                                    <i data-lucide="external-link" className="w-4 h-4 mx-auto"></i>
                                                                </a>
                                                            ) : <span className="text-slate-300">-</span>}
                                                        </td>
                                                    </tr>
                                                );
                                            })
                                        ) : (
                                            <tr>
                                                <td colspan="7" className="p-8 text-center text-slate-400 italic">
                                                    Nenhuma movimentação encontrada para este filtro.
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
